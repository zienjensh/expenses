rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user owns the document
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
    
    // Helper function to check if current user is admin
    function isAdmin() {
      // Check if user document has isAdmin field set to true
      return request.auth != null && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }
    
    // Helper function to check if user ID is in hardcoded admin list
    function isHardcodedAdmin() {
      return request.auth != null && 
        (request.auth.uid == 'ikNkNLykEeUtXiecovWJSlVg2K33');
    }
    
    // Combined admin check
    function isAdminUser() {
      return isAdmin() || isHardcodedAdmin();
    }
    
    // Expenses collection rules
    match /expenses/{expenseId} {
      // Users can read their own expenses, admins can read all expenses
      allow read: if request.auth != null && 
        (resource == null || resource.data.userId == request.auth.uid || isAdminUser());
      
      allow create: if request.auth != null && 
        request.resource.data.userId == request.auth.uid;
      
      allow update, delete: if request.auth != null && 
        resource.data.userId == request.auth.uid;
    }
    
    // Revenues collection rules
    match /revenues/{revenueId} {
      // Users can read their own revenues, admins can read all revenues
      allow read: if request.auth != null && 
        (resource == null || resource.data.userId == request.auth.uid || isAdminUser());
      
      allow create: if request.auth != null && 
        request.resource.data.userId == request.auth.uid;
      
      allow update, delete: if request.auth != null && 
        resource.data.userId == request.auth.uid;
    }
    
    // Projects collection rules
    match /projects/{projectId} {
      // Users can read their own projects, admins can read all projects
      allow read: if request.auth != null && 
        (resource == null || resource.data.userId == request.auth.uid || isAdminUser());
      
      allow create: if request.auth != null && 
        request.resource.data.userId == request.auth.uid;
      
      allow update, delete: if request.auth != null && 
        resource.data.userId == request.auth.uid;
    }
    
    // Allow admins to list all expenses, revenues, and projects
    match /expenses {
      allow list: if request.auth != null && isAdminUser();
    }
    
    match /revenues {
      allow list: if request.auth != null && isAdminUser();
    }
    
    match /projects {
      allow list: if request.auth != null && isAdminUser();
    }
    
    // Users collection rules (for user preferences like currency)
    match /users/{userId} {
      // Users can read their own data, admins can read all users
      allow read: if request.auth != null && 
        (request.auth.uid == userId || isAdminUser());
      
      // Users can create their own document, admins can create any user document
      allow create: if request.auth != null && 
        ((request.auth.uid == userId && request.resource.data.userId == request.auth.uid) ||
         isAdminUser());
      
      // Users can update their own data (but not isAdmin field), admins can update any user data
      allow update: if request.auth != null && 
        ((request.auth.uid == userId && 
          resource.data.userId == request.auth.uid &&
          !request.resource.data.diff(resource.data).affectedKeys().hasAny(['isAdmin'])) ||
         (isAdminUser() && resource.data.userId == userId));
      
      // Allow admins to delete user documents
      allow delete: if request.auth != null && isAdminUser();
    }
    
    // Allow admins to list all users
    match /users {
      allow list: if request.auth != null && isAdminUser();
    }
    
    // Usernames collection rules (for username to email mapping)
   // Allow read without auth for login purposes (only username and email, no sensitive data)
    match /usernames/{usernameId} {
      // Allow read without authentication (needed for login)
      allow read: if true;
      
      // Only authenticated users can create usernames for themselves
      allow create: if request.auth != null &&
        request.resource.data.userId == request.auth.uid &&
        request.resource.data.email != null &&
        request.resource.data.username != null;
      
      allow update: if false; // Usernames cannot be updated
      
      allow delete: if false; // Usernames cannot be deleted
    }
    
    // Allow querying usernames collection for login (by phoneNumber or username)
    match /usernames {
      allow list: if true; // Allow queries for login purposes
    }
    
    // System collection rules (for site status and system-wide settings)
    match /system/{documentId} {
      // Everyone can read system status (needed for maintenance mode check)
      allow read: if true;
      
      // Only admins can write to system settings
      allow write: if request.auth != null && isAdminUser();
    }
    
    // Activity Logs collection rules
    match /activityLogs/{logId} {
      // Users can read their own activity logs, admins can read all logs
      allow read: if request.auth != null && 
        (resource == null || resource.data.userId == request.auth.uid || isAdminUser());
      
      // Users can create their own activity logs
      // Ensure userId in the document matches the authenticated user
      allow create: if request.auth != null && 
        request.resource.data.userId == request.auth.uid;
      
      // No updates or deletes allowed (immutable log)
      allow update, delete: if false;
    }
    
    // Allow admins to list all activity logs
    match /activityLogs {
      allow list: if request.auth != null && isAdminUser();
    }
    
    // Notifications collection rules
    match /notifications/{notificationId} {
      // Users can read their own notifications, admins can read all notifications
      allow read: if request.auth != null && 
        (resource == null || resource.data.userId == request.auth.uid || isAdminUser());
      
      // Only admins can create notifications
      allow create: if request.auth != null && isAdminUser() &&
        request.resource.data.userId != null &&
        request.resource.data.title != null &&
        request.resource.data.message != null &&
        request.resource.data.type != null &&
        request.resource.data.icon != null &&
        request.resource.data.createdBy == request.auth.uid;
      
      // Users can update their own notifications (mark as read, etc.), admins can update any notification
      allow update: if request.auth != null && 
        (resource.data.userId == request.auth.uid || isAdminUser());
      
      // Users can delete their own notifications, admins can delete any notification
      allow delete: if request.auth != null && 
        (resource.data.userId == request.auth.uid || isAdminUser());
    }
    
    // Allow admins to list all notifications
    match /notifications {
      allow list: if request.auth != null && isAdminUser();
    }
    
    // Support Conversations collection rules
    match /supportConversations/{conversationId} {
      // Users can read their own conversations, admins can read all conversations
      allow read: if request.auth != null && 
        (resource.data.userId == request.auth.uid || isAdminUser());
      
      // Users can create their own conversations
      allow create: if request.auth != null && 
        request.resource.data.userId == request.auth.uid &&
        request.resource.data.userEmail != null &&
        request.resource.data.status != null;
      
      // Users can update their own conversations (status), admins can update any conversation
      allow update: if request.auth != null && 
        (resource.data.userId == request.auth.uid || isAdminUser());
      
      // Only admins can delete conversations
      allow delete: if request.auth != null && isAdminUser();
    }
    
    // Allow admins to list all conversations
    match /supportConversations {
      allow list: if request.auth != null && isAdminUser();
    }
    
    // Support Messages collection rules
    match /supportMessages/{messageId} {
      // Helper function to check if user owns the conversation
      function isConversationOwner() {
        return resource != null &&
               resource.data.conversationId != null &&
               exists(/databases/$(database)/documents/supportConversations/$(resource.data.conversationId)) &&
               get(/databases/$(database)/documents/supportConversations/$(resource.data.conversationId)).data.userId == request.auth.uid;
      }
      
      // Helper function for request (when creating new message)
      function isRequestConversationOwner() {
        return request.resource.data.conversationId != null &&
               exists(/databases/$(database)/documents/supportConversations/$(request.resource.data.conversationId)) &&
               get(/databases/$(database)/documents/supportConversations/$(request.resource.data.conversationId)).data.userId == request.auth.uid;
      }
      
      // Users can read messages from their conversations, admins can read all messages
      allow read: if request.auth != null && (resource == null || isConversationOwner() || isAdminUser());
      
      // Users can create messages in their own conversations, admins can create messages in any conversation
      allow create: if request.auth != null && (
        (exists(/databases/$(database)/documents/supportConversations/$(request.resource.data.conversationId)) &&
         get(/databases/$(database)/documents/supportConversations/$(request.resource.data.conversationId)).data.userId == request.auth.uid &&
         request.resource.data.sender == 'user' &&
         request.resource.data.senderId == request.auth.uid) ||
        (isAdminUser() &&
         request.resource.data.sender == 'admin' &&
         request.resource.data.senderId == request.auth.uid)
      );
      
      // Users can update their own messages (readBy), admins can update any message
      allow update: if request.auth != null && 
        (resource.data.senderId == request.auth.uid || isAdminUser());
      
      // Only admins can delete messages
      allow delete: if request.auth != null && isAdminUser();
    }
    
    // Allow users to query messages - the where clause will filter by conversationId
    // and the read permission on individual messages will enforce access control
    match /supportMessages {
      // Allow list queries - Firestore will check individual message permissions
      allow list: if request.auth != null;
    }
    
    // Budgets collection rules
    match /budgets/{budgetId} {
      allow read: if request.auth != null && 
        (resource == null || resource.data.userId == request.auth.uid || isAdminUser());
      allow create: if request.auth != null && 
        request.resource.data.userId == request.auth.uid;
      allow update, delete: if request.auth != null && 
        resource.data.userId == request.auth.uid;
    }
    
    match /budgets {
      allow list: if request.auth != null;
    }
    
    // Financial Goals collection rules
    match /financialGoals/{goalId} {
      allow read: if request.auth != null && 
        (resource == null || resource.data.userId == request.auth.uid || isAdminUser());
      allow create: if request.auth != null && 
        request.resource.data.userId == request.auth.uid;
      allow update, delete: if request.auth != null && 
        resource.data.userId == request.auth.uid;
    }
    
    match /financialGoals {
      allow list: if request.auth != null;
    }
    
    // Recurring Bills collection rules
    match /recurringBills/{billId} {
      allow read: if request.auth != null && 
        (resource == null || resource.data.userId == request.auth.uid || isAdminUser());
      allow create: if request.auth != null && 
        request.resource.data.userId == request.auth.uid;
      allow update, delete: if request.auth != null && 
        resource.data.userId == request.auth.uid;
    }
    
    match /recurringBills {
      allow list: if request.auth != null;
    }
    
    // Custom Categories collection rules
    match /customCategories/{categoryId} {
      allow read: if request.auth != null && 
        (resource == null || resource.data.userId == request.auth.uid || isAdminUser());
      allow create: if request.auth != null && 
        request.resource.data.userId == request.auth.uid;
      allow update, delete: if request.auth != null && 
        resource.data.userId == request.auth.uid;
    }
    
    match /customCategories {
      allow list: if request.auth != null;
    }
    
    // Savings Challenges collection rules
    match /savingsChallenges/{challengeId} {
      allow read: if request.auth != null && 
        (resource == null || resource.data.userId == request.auth.uid || isAdminUser());
      allow create: if request.auth != null && 
        request.resource.data.userId == request.auth.uid;
      allow update, delete: if request.auth != null && 
        resource.data.userId == request.auth.uid;
    }
    
    // Achievements/Rewards collection rules
    match /achievements/{achievementId} {
      allow read: if request.auth != null && 
        (resource == null || resource.data.userId == request.auth.uid || isAdminUser());
      allow create: if request.auth != null && 
        request.resource.data.userId == request.auth.uid;
      allow update, delete: if request.auth != null && 
        resource.data.userId == request.auth.uid;
    }
    
    // Groups collection rules (for group mode)
    match /groups/{groupId} {
      allow read: if request.auth != null && 
        (resource == null || 
         resource.data.members.hasAny([request.auth.uid]) || 
         resource.data.ownerId == request.auth.uid || 
         isAdminUser());
      allow create: if request.auth != null && 
        request.resource.data.ownerId == request.auth.uid;
      allow update: if request.auth != null && 
        (resource.data.ownerId == request.auth.uid || 
         resource.data.members.hasAny([request.auth.uid]) || 
         isAdminUser());
      allow delete: if request.auth != null && 
        (resource.data.ownerId == request.auth.uid || isAdminUser());
    }
    
    // Travel Expenses collection rules
    match /travelExpenses/{expenseId} {
      allow read: if request.auth != null && 
        (resource == null || resource.data.userId == request.auth.uid || isAdminUser());
      allow create: if request.auth != null && 
        request.resource.data.userId == request.auth.uid;
      allow update, delete: if request.auth != null && 
        resource.data.userId == request.auth.uid;
    }
    
    // Backup Data collection rules
    match /backups/{backupId} {
      allow read: if request.auth != null && 
        (resource == null || resource.data.userId == request.auth.uid || isAdminUser());
      allow create: if request.auth != null && 
        request.resource.data.userId == request.auth.uid;
      allow update, delete: if request.auth != null && 
        resource.data.userId == request.auth.uid;
    }
  }
}

