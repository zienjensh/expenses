rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user owns the document
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
    
    // Helper function to check if current user is admin
    function isAdmin() {
      // Check if user document has isAdmin field set to true
      return request.auth != null && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }
    
    // Helper function to check if user ID is in hardcoded admin list
    function isHardcodedAdmin() {
      return request.auth != null && 
        (request.auth.uid == 'ikNkNLykEeUtXiecovWJSlVg2K33');
    }
    
    // Combined admin check
    function isAdminUser() {
      return isAdmin() || isHardcodedAdmin();
    }
    
    // Expenses collection rules
    match /expenses/{expenseId} {
      // Users can read their own expenses, admins can read all expenses
      allow read: if request.auth != null && 
        (resource == null || resource.data.userId == request.auth.uid || isAdminUser());
      
      allow create: if request.auth != null && 
        request.resource.data.userId == request.auth.uid;
      
      allow update, delete: if request.auth != null && 
        resource.data.userId == request.auth.uid;
    }
    
    // Revenues collection rules
    match /revenues/{revenueId} {
      // Users can read their own revenues, admins can read all revenues
      allow read: if request.auth != null && 
        (resource == null || resource.data.userId == request.auth.uid || isAdminUser());
      
      allow create: if request.auth != null && 
        request.resource.data.userId == request.auth.uid;
      
      allow update, delete: if request.auth != null && 
        resource.data.userId == request.auth.uid;
    }
    
    // Projects collection rules
    match /projects/{projectId} {
      // Users can read their own projects, admins can read all projects
      allow read: if request.auth != null && 
        (resource == null || resource.data.userId == request.auth.uid || isAdminUser());
      
      allow create: if request.auth != null && 
        request.resource.data.userId == request.auth.uid;
      
      allow update, delete: if request.auth != null && 
        resource.data.userId == request.auth.uid;
    }
    
    // Allow admins to list all expenses, revenues, and projects
    match /expenses {
      allow list: if request.auth != null && isAdminUser();
    }
    
    match /revenues {
      allow list: if request.auth != null && isAdminUser();
    }
    
    match /projects {
      allow list: if request.auth != null && isAdminUser();
    }
    
    // Users collection rules (for user preferences like currency)
    match /users/{userId} {
      // Users can read their own data, admins can read all users
      allow read: if request.auth != null && 
        (request.auth.uid == userId || isAdminUser());
      
      // Users can create their own document, admins can create any user document
      allow create: if request.auth != null && 
        ((request.auth.uid == userId && request.resource.data.userId == request.auth.uid) ||
         isAdminUser());
      
      // Users can update their own data (but not isAdmin field), admins can update any user data
      allow update: if request.auth != null && 
        ((request.auth.uid == userId && 
          resource.data.userId == request.auth.uid &&
          !request.resource.data.diff(resource.data).affectedKeys().hasAny(['isAdmin'])) ||
         (isAdminUser() && resource.data.userId == userId));
      
      // Allow admins to delete user documents
      allow delete: if request.auth != null && isAdminUser();
    }
    
    // Allow admins to list all users
    match /users {
      allow list: if request.auth != null && isAdminUser();
    }
    
    // Usernames collection rules (for username to email mapping)
   // Allow read without auth for login purposes (only username and email, no sensitive data)
    match /usernames/{usernameId} {
      // Allow read without authentication (needed for login)
      allow read: if true;
      
      // Only authenticated users can create usernames for themselves
      allow create: if request.auth != null &&
        request.resource.data.userId == request.auth.uid &&
        request.resource.data.email != null &&
        request.resource.data.username != null;
      
      allow update: if false; // Usernames cannot be updated
      
      allow delete: if false; // Usernames cannot be deleted
    }
    
    // System collection rules (for site status and system-wide settings)
    match /system/{documentId} {
      // Everyone can read system status (needed for maintenance mode check)
      allow read: if true;
      
      // Only admins can write to system settings
      allow write: if request.auth != null && isAdminUser();
    }
    
    // Activity Logs collection rules
    match /activityLogs/{logId} {
      // Users can read their own activity logs, admins can read all logs
      allow read: if request.auth != null && 
        (resource == null || resource.data.userId == request.auth.uid || isAdminUser());
      
      // Users can create their own activity logs
      // Ensure userId in the document matches the authenticated user
      allow create: if request.auth != null && 
        request.resource.data.userId == request.auth.uid;
      
      // No updates or deletes allowed (immutable log)
      allow update, delete: if false;
    }
    
    // Allow admins to list all activity logs
    match /activityLogs {
      allow list: if request.auth != null && isAdminUser();
    }
  }
}

